load( "framework.asc" );
application.onAppStart = function() {
	queue_so = SharedObject.get("queue_so");
	trace("the queue app has started");
};
application.onConnect = function(client, uname) {
	gFrameworkFC.getClientGlobals(client).username = uname;
	trace(uname + " has connected");

	client.myTest = function(p_state, p_lang, p_mathCert)
	{
		var returnObj = new Array();
		var returnValue = "notSet";
		var returnName = "none";
		
		trace("the number of tutors online is : " + queue_so.size());
		
		if(queue_so.size() > 0)
		{
			
			var tutorArray = new Array();
			
			
			var soNames= queue_so.getPropertyNames();
			var i = 0;
			var numTutors = 0;
			
			while(i<queue_so.size())
			{
				trace("this is looking for : " + soNames[i] + queue_so.getProperty(soNames[i])._tutorName);
				
				if (queue_so.getProperty(soNames[i])._acceptingStudents == true)
				{
						
					tutorArray[numTutors] = queue_so.getProperty(soNames[i]);
					
					
					if(tutorArray[numTutors]._language.toLowerCase() ==  p_lang.toLowerCase())
					{
						tutorArray[numTutors]._bitArray = 1;
					}
					else
					{
						tutorArray[numTutors]._bitArray = 0;
					}
					trace("first : " + tutorArray[numTutors]._bitArray);
					tutorArray[numTutors]._bitArray <<= 1;
					
					trace("the two math certs are " +tutorArray[numTutors]._mathCertified + " : " + p_mathCert);
					
					if(tutorArray[numTutors]._mathCertified ==  p_mathCert)
					{
	
						tutorArray[numTutors]._bitArray += 1;
					}
					trace("second : " + tutorArray[numTutors]._bitArray);
					tutorArray[numTutors]._bitArray <<= 1;
					
					
					if(tutorArray[numTutors]._state.toLowerCase() ==  p_state.toLowerCase())
					{
						tutorArray[numTutors]._bitArray += 1;
					}
					
					//tutorArray[i]._bitArray <<= 1;
					
					trace("the final is :" + tutorArray[numTutors]._bitArray);
					//returnValue = returnValue + "this is my test" + tutorArray[i]._tutorName + " : " + tutorArray.length; //+ " : " + 
					//p_lang + p_mathCert + p_state;
					i++;
					numTutors++;
				}
				else
				{
					i++;
				}
			}
			
			if(numTutors > 0)
			{
			
				trace("the first value before teh sort is : " + tutorArray[0]._bitArray);			
				tutorArray = myBubbleSort(tutorArray,"_bitArray");
				trace("the first value after teh sort is : " + tutorArray[0]._bitArray);			
				
				i = 0;
				var temp_so;
				var leastPercentBusy = 10000;
				var leastBusyTutorLine;
				var leastBusyTutorName;
				while(i<tutorArray.length)
				{
					trace("loop : " + i);
					tempso = SharedObject.get(tutorArray[i]._tutorLineName);
					if (tempso.size() < tutorArray[i]._maxStudents)
					{
						trace("the tutor " + tutorArray[i]._tutorName + " can take the student.");
						returnValue = tutorArray[i]._tutorLineName;
						returnName = tutorArray[i]._tutorName;
						i = tutorArray.length;
					}
					else
					{
						
						tutorArray[i]._percentBusy = (tempso.size()/tutorArray[i]._maxStudents * 100);
						if (tutorArray[i]._percentBusy < leastPercentBusy)
						{
							leastPercentBusy = tutorArray[i]._percentBusy;
							leastBusyTutorLine = tutorArray[i]._tutorLineName;
							leastBusyTutorName = tutorArray[i]._tutorName;
						}
						trace("the tutor " + tutorArray[i]._tutorName + " is " + tutorArray[i]._percentBusy + " percent busy");
						i++;
					}
				}
				if (returnValue == "notSet")
				{
					//this should get the least busy tutor.
					returnValue =  leastBusyTutorLine;
					returnName = leastBusyTutorName;
				}
				
			}
			else
			{
				//This means that there are no tutors online
				returnValue = "none";
			}

		}
		else
		{
			//This means that there are no tutors online
			returnValue = "none";
		}
		
		
		returnObj[0] = returnValue;
		returnObj[1] = returnName;
		return returnObj;
		
	};

	application.acceptConnection(client);
	
};
application.onDisconnect = function(client) {
	var userInfo = gFrameworkFC.getClientGlobals(client);
	queue_so.setProperty("t_"+userInfo.username,null);

	trace("Student " + userInfo.username + " has disconnected.");
	for (var i = 0; i < application.clients.length; i++) {
		var c = application.clients[i];
		c.call("disconnect_s",null,userInfo.username);
	}
	
	queue_so.setProperty("s_"+userInfo.username,null);
	trace(userInfo.username+" disconnected!!!!!!!!");
};

function myBubbleSort(a, sortColumn)
{        
	//trace("in the bubble sort :" + typeof(a));
	if (typeof(a) == "undefined")
	{
		return a;
	}
	else
	{
		var i = 0;
		
		while (i < a.length-1)
		{
			
			if(a[i][sortColumn] < a[i+1][sortColumn])
			{
				var tempVal1 = a[i];
				var tempVal2 = a[i+1];
				
				a[i] = tempVal2;
				a[i+1] = tempVal1;
				
				i =0;
			}
			else
			{
				i++;
			}
		}
			
		return a;
	}
}

/*
load( "framework.asc" );
application.onAppStart = function() {
	queue_so = SharedObject.get("queue_so");
};
application.onConnect = function(client, uname) {
	gFrameworkFC.getClientGlobals(client).username = uname;
	trace(uname + " has connected");
	application.acceptConnection(client);
};
application.onDisconnect = function(client) {
	var userInfo = gFrameworkFC.getClientGlobals(client);
	queue_so.setProperty("t_"+userInfo.username,null);

	trace("Student " + userInfo.username + " has disconnected.");
	for (var i = 0; i < application.clients.length; i++) {
		var c = application.clients[i];
		c.call("disconnect_s",null,userInfo.username);
	}
	
	queue_so.setProperty("s_"+userInfo.username,null);
	trace(userInfo.username+" disconnected!!!!!!!!");
};
*/